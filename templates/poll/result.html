{% extends "base.html" %}
{% load staticfiles %}

{% block content %}
  <div class="header">
    <h1>{% block title %}{{ poll.long_title }}{% endblock %}</h1>
    <h2>Text your votes to +44 161 850 5879</h2>
  </div>

  <div class="results-container">
    {% for po in poll_options %}
      <div class="result{% if forloop.first %} winner{% endif %}" data-poll-option-title="{{ po.title }}" data-vote-count="{{ po.vote_count }}">
        <div class="beer-image-container">
          <img class="beer" src="{% static 'img/beer.png' %}" width="343" height="852" />
          <img class="beer-glass" src="{% static 'img/beer_glass.png' %}" width="343" height="852" />
        </div>
        <div class="info">
          <span class="poll-option-title">{{ po.title }}</span>
          <span class="poll-vote-count">{{ po.vote_count }}</span>
        </div>
      </div>
    {% endfor %}
  </div>

  <script type="text/javascript">
    var unit_height;

    function render_results(votes) {
      // console.log(votes);
      $('.result').each(function() {
        var max_votes = votes.max_votes;
        var vote_title = $(this).attr('data-poll-option-title');
        var vote_count = votes[vote_title];

        var count_from_max = max_votes - vote_count;
        // console.log('Vote Title: ' + vote_title + ', Vote Count: ' + vote_count + ', count_from_max: ' + count_from_max + ', unit_height: ' + unit_height);
        $(this).find('.beer').css('top', count_from_max * unit_height);
        $(this).find('.poll-vote-count').text(vote_count);
      });
    } 

    var max_votes = parseInt($('.winner').attr('data-vote-count'));
    var scale_factor = (($(window).height() - 140) / $('.beer').height());

    var height = $('.beer').height();
    var width = $('.beer').width();

    var new_height = height * scale_factor;
    var new_width = width * scale_factor;

    $('.beer').height(new_height);
    $('.beer').width(width * scale_factor);
    $('.beer-glass').height(new_height);
    $('.beer-glass').width(width * scale_factor);
    $('.beer-image-container').height(new_height);
    $('.beer-image-container').width(width * scale_factor);

    unit_height = new_height / max_votes;

    var votes = {'max_votes': max_votes};
    $('.result').each(function() {
        var vote_title = $(this).attr('data-poll-option-title');
        votes[vote_title] = parseInt($(this).attr('data-vote-count'));
      });

    render_results(votes);

    function update_display() {
      $.get('{% url 'poll_refresh' poll.pk poll.slug %}', function(data) {
        render_results(data);
      });
    }

    setInterval(update_display, 1000);

  </script>

 {% endblock %}